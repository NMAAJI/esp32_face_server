<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="ESP32 face recognition dashboard - upload and manage wanted person images, view server status and registered faces.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Face Recognition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff; /* full white background */
            min-height: 100vh;
            padding: 20px;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }
        .container {
            max-width: 940px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
        }
        h1 {
            color: #222;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .subtitle {
            text-align: center;
            color: #444;
            margin-bottom: 30px;
        }
        .section {
            background: #fbfbfb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
        }
        .section h2::before {
            content: "üì∏";
            margin-right: 10px;
        }
        form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        input[type="file"] {
            flex: 1 1 220px;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 6px;
            background: white;
        }
        input[type="text"] {
            flex: 1 1 200px;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 6px;
            font-size: 14px;
            background: #fff;
        }
        button {
            padding: 10px 18px;
            background: #4b7bec;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }
        input:focus, button:focus {
            outline: 3px solid rgba(102,126,234,0.25);
            outline-offset: 2px;
        }
        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .face-list {
            list-style: none;
        }
        .face-item {
            background: #fff;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 4px rgba(28,31,36,0.04);
        }
        .face-item .meta { display:flex; align-items:center; gap:12px; }
        .face-thumb { width:56px; height:56px; object-fit:cover; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
        .face-name {
            font-weight: bold;
            color: #333;
        }
        .delete-btn {
            background: #ff4757;
            padding: 5px 15px;
            font-size: 12px;
        }
        .delete-btn:hover {
            background: #ff3838;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .status {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .info-box h3 {
            color: #1976d2;
            margin-bottom: 5px;
        }
        .info-box p {
            color: #555;
            line-height: 1.5;
        }
        .sr-only { position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
        #preview img { max-width:80px; border-radius:8px; margin-top:8px; display:inline-block; }
        /* Responsive adjustments */
        @media (max-width: 700px) {
            .container { margin: 0 12px; padding: 18px; border-radius: 10px; }
            h1 { font-size: 1.4rem; }
            .section { padding: 14px; }
            form { flex-direction: column; align-items: stretch; }
            input[type="text"], input[type="file"], button { width: 100%; }
            .face-item { flex-direction: column; align-items: flex-start; gap: 8px; }
            .face-thumb { width:48px; height:48px; }
            #liveFeed { width: 100%; height: auto; }
            #liveFeedWrap { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí ESP32 Face Recognition System</h1>
        <p class="subtitle">Upload wanted person images and manage detection</p>

        <div class="info-box">
            <h3>‚ÑπÔ∏è How It Works</h3>
            <p>1. Upload a clear face photo of the wanted person<br>
            2. ESP32-CAM will detect when this person appears<br>
            3. You'll receive an email alert with captured image</p>
        </div>

        <div class="section">
            <h2>Upload Wanted Person</h2>
            <form action="/register" method="post" enctype="multipart/form-data">
                <!-- If your app uses CSRF protection, include the CSRF token server-side (e.g., Flask-WTF's csrf_token()). -->
                <label for="name" class="sr-only">Person name</label>
                <input id="name" type="text" name="name" placeholder="Person name (e.g., John)" required aria-label="Person name">

                <label for="image" class="sr-only">Face image</label>
                <input id="image" type="file" name="image" accept="image/*" required aria-describedby="imageHelp">
                <div id="preview" aria-hidden="true"></div>
                <div id="imageHelp" style="display:none">Choose a clear photo with only the person's face visible.</div>

                <button type="submit">‚ûï Add Face</button>
            </form>
        </div>

        <div class="section">
            <h2 style="margin-bottom: 20px;">üìã Registered Faces ({{ faces|length }})</h2>
            {% if faces %}
                <ul class="face-list" role="list">
                    {% for face in faces %}
                    <li class="face-item">
                        <div class="meta">
                            <img src="/known_faces/{{ face }}" alt="Face of {{ face.replace('.jpg','').replace('.jpeg','').replace('.png','') }}" class="face-thumb">
                            <span class="face-name">üë§ {{ face.replace('.jpg', '').replace('.jpeg', '').replace('.png', '') }}</span>
                        </div>
                        <div>
                            <a href="/delete/{{ face }}" class="delete-link" data-face="{{ face }}">
                                <button type="button" class="delete-btn">üóëÔ∏è Delete</button>
                            </a>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="empty-state">
                    <p>No faces registered yet.</p>
                    <p style="font-size: 12px; margin-top: 10px;">Upload your first wanted person above.</p>
                </div>
            {% endif %}
        </div>

        <div class="section">
            <h2>üöÄ Server Status</h2>
            <div class="status" role="status" aria-live="polite">
                ‚úÖ Server Running - Ready to detect faces
            </div>
            <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
                <div id="liveFeedWrap" style="display:flex; gap:12px; align-items:center;">
                    <img id="liveFeed" src="/static/latest.jpg" alt="Live feed" style="width:220px; height:160px; object-fit:cover; border-radius:6px; border:1px solid #eee;">
                                        <div style="display:flex; flex-direction:column; gap:6px;">
                                                <small style="color:#666;">Live feed (auto-updates)</small>
                                                <div style="display:flex; gap:6px;">
                                                    <button id="refreshLive" type="button" style="padding:6px 10px; font-size:12px;">Refresh Now</button>
                                                    <button id="fullscreenLive" type="button" style="padding:6px 10px; font-size:12px;">‚§¢ Fullscreen</button>
                                                </div>
                                        </div>
                </div>
            </div>
            <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
                <button id="enableTestBtn" type="button">üîî Enable Test Mail (20m)</button>
                <button id="sendTestBtn" type="button" style="display:none; background:#2196f3;">‚úâÔ∏è Send Test Email</button>
                <span id="testTimer" style="color:#666; font-size:13px;"></span>
            </div>
            <p style="margin-top: 15px; color: #666; font-size: 14px;">
                <strong>ESP32 Upload URL:</strong><br>
                <code style="background: #f0f0f0; padding: 5px 10px; border-radius: 3px; display: inline-block; margin-top: 5px;">
                    http://YOUR_IP:5000/upload
                </code>
            </p>
        </div>
    </div>
    <script>
        // Image preview for upload
        (function(){
            const input = document.getElementById('image');
            const preview = document.getElementById('preview');
            if (input && preview) {
                input.addEventListener('change', function(e){
                    preview.innerHTML = '';
                    const file = this.files && this.files[0];
                    if (!file) return;
                    if (!file.type.startsWith('image/')) return;
                    const img = document.createElement('img');
                    img.alt = 'Selected image preview';
                    img.src = URL.createObjectURL(file);
                    img.onload = () => URL.revokeObjectURL(img.src);
                    preview.appendChild(img);
                });
            }

            // Delete confirmation
            document.addEventListener('click', function(e){
                const link = e.target.closest && e.target.closest('.delete-link');
                if (!link) return;
                const ok = confirm('Delete this registered face? This action cannot be undone.');
                if (!ok) e.preventDefault();
            });
        })();

        // Temporary Test Mail UI
        (function(){
            const enableBtn = document.getElementById('enableTestBtn');
            const sendBtn = document.getElementById('sendTestBtn');
            const timerSpan = document.getElementById('testTimer');
            let expiry = 0;
            let timerInterval = null;

            function updateUI(){
                const now = Date.now()/1000;
                if (expiry && expiry > now){
                    sendBtn.style.display = 'inline-block';
                    enableBtn.style.display = 'none';
                    const remaining = Math.max(0, Math.floor(expiry - now));
                    const mins = Math.floor(remaining/60);
                    const secs = remaining % 60;
                    timerSpan.textContent = `Expires in ${mins}m ${secs}s`;
                } else {
                    sendBtn.style.display = 'none';
                    enableBtn.style.display = 'inline-block';
                    timerSpan.textContent = '';
                }
            }

            function startTimer(){
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(()=>{
                    updateUI();
                    if (!expiry || expiry <= Date.now()/1000) clearInterval(timerInterval);
                }, 1000);
            }

            // fetch current status on load
            fetch('/test_mail_status').then(r=>r.json()).then(j=>{
                expiry = j.expiry || 0;
                updateUI();
                if (expiry && expiry > Date.now()/1000) startTimer();
            }).catch(()=>{});

            enableBtn.addEventListener('click', function(){
                fetch('/enable_test_mail', {method:'POST'}).then(r=>r.json()).then(j=>{
                    expiry = j.expiry || 0;
                    updateUI();
                    startTimer();
                }).catch(err=>{ alert('Failed to enable test button'); console.error(err); });
            });

            sendBtn.addEventListener('click', function(){
                sendBtn.disabled = true;
                fetch('/send_test_mail', {method:'POST'}).then(r=>r.json()).then(j=>{
                    sendBtn.disabled = false;
                    if (j.sent) alert('Test email sent'); else alert('Failed sending test email');
                }).catch(e=>{ sendBtn.disabled = false; alert('Error sending'); console.error(e); });
            });
        })();

        // Live feed auto-refresh
        (function(){
            const img = document.getElementById('liveFeed');
            const btn = document.getElementById('refreshLive');
            function refresh(){
                img.src = '/static/latest.jpg?ts=' + Date.now();
            }
            btn.addEventListener('click', refresh);
            setInterval(refresh, 2000);
        })();

        // Fullscreen handler for live feed
        (function(){
            const fsBtn = document.getElementById('fullscreenLive');
            const imgWrap = document.getElementById('liveFeedWrap');
            if (!fsBtn) return;
            function enterFull(el){
                if (el.requestFullscreen) el.requestFullscreen();
                else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
                else if (el.msRequestFullscreen) el.msRequestFullscreen();
            }
            fsBtn.addEventListener('click', function(){
                enterFull(imgWrap || document.getElementById('liveFeed'));
            });
        })();
    </script>
</body>
</html>